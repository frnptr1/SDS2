---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

```{r, warning=FALSE}
rm(list = ls())
library(rjags)
library(R2jags)
library(coda)
library(ggmcmc)
library(boot)
library(ggplot2)
library(magrittr)
library(dplyr)
library(RColorBrewer)
```



```{r}
data = list(rt = c(3, 7, 5, 102, 28, 4, 98, 60, 25, 138, 64, 45, 9, 57, 25, 33, 28, 8, 6, 32, 27, 22 ),
            nt = c(38, 114, 69, 1533, 355, 59, 945, 632, 278,1916, 873, 263, 291, 858, 154, 207, 251, 151, 174, 209, 391, 680),
            rc = c(3, 14, 11, 127, 27, 6, 152, 48, 37, 188, 52, 47, 16, 45, 31, 38, 12, 6, 3, 40, 43, 39),
            nc = c(39, 116, 93, 1520, 365, 52, 939, 471, 282, 1921, 583, 266, 293, 883, 147, 213, 122, 154, 134, 218, 364, 674),
            Num = 22)
```


```{r}
p_c = data$rt/data$nt
p_t = data$rc/data$nc
logit_pc = logit(p_c)
logit_pt = logit(p_t)
```

```{r}
# histogram of the logit of probailities observed
ggplot(data = data.frame(x = logit_pc), aes(x)) +
  theme_bw()+
  theme(plot.title = element_text(size = 15))+
  geom_histogram(bins = 5,
                 color = "blue3",
                 fill = "cornflowerblue")+
  labs(title = "Histogram of empirical log odds",subtitle = "Control Group", x = "Logit(p)", y = "Frequency")


ggplot(data = data.frame(x = logit_pt), aes(x)) +
  theme_bw() +
  theme(plot.title = element_text(size = 15))+
  geom_histogram(bins = 7,
                 color = "forestgreen",
                 fill = "darkolivegreen1")+
  labs(title = "Histogram of empirical log odds",subtitle = "Treatment Group", x = "Logit(p)", y = "Frequency")
```


```{r}
# prior distribution of mean and variance of delta
# plot of nu and precision tau
ggplot(data = data.frame(x = c(-1000, 1000)), aes(x)) + 
  theme_bw() + 
  theme(plot.title = element_text(size = 35), text = element_text(size=30))+
  stat_function(fun = dnorm, args = list(mean = 0, sd = 1/sqrt(10e-6)), size = 2, color = "red")+
  labs(title = expression(paste("Prior distribution of ", nu)), y = "Probability", x = expression(nu))


ggplot(data = data.frame(x = c(0.,1)), aes(x))+
  theme_bw() + 
  theme(plot.title = element_text(size = 35), text = element_text(size=30))+
  stat_function(fun = dgamma, args = list(shape = 0.001, rate = 0.001),size = 2, color = "blue")+
  labs(title = expression(paste("Prior distribution of ", tau)), y="Probability", x = expression(nu))

```


```{r}
# in order to plot the prior distribution of the random effect delta, just to have an idea of how it looks like, i can evaluate the expected value of nu and sigma2 and use those value as parameter in the Normal distribution of delta (random effect)

# We already know that the expected value in a normal distribution is just the mean (0 in case of nu)
# The only thing left is the expected value of the gamma distribution (expected value of the variance sigma2)

# The expected value of Gamma distribution is E = shape/rate = 0.001/0.001 = 1

# The prior distribution of delta random effect will be the a Normal(0,1)

ggplot(data = data.frame(x = c(-3, 3)), aes(x)) + 
  theme_bw() +
  theme(plot.title = element_text(size = 35), text = element_text(size=30))+
  stat_function(fun = dnorm, args = list(mean = 0, sd = 1), size=2, color = "green") +
  labs(title = expression(paste("Prior distribution of " , delta )), x = expression(delta), y = "Probability" )

```



```{r}
model1 = "
      model
      {
         for( i in 1 : Num ) {
            rc[i] ~ dbin(pc[i], nc[i])
            rt[i] ~ dbin(pt[i], nt[i])
            logit(pc[i]) <- mu[i]
            logit(pt[i]) <- mu[i] + delta[i]
            mu[i] ~ dnorm(0.0,1.0E-5)
            delta[i] ~ dnorm(nu, tau)
         }
         nu ~ dnorm(0.0,1.0E-6)
         tau ~ dgamma(0.001,0.001)
         delta.new ~ dnorm(nu, tau)
         sigma <- 1 / sqrt(tau)
      }"

writeLines( model1 , con="m1" )
```

```{r}
init = function() list("nu" = 0,     # mean of random effect delta
             "delta.new" = 0,   # value coming from the predictive distribution of delta
             "tau"=1,           # prior precision of Normal distribution of delta
             "mu" = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0), # 0 mu for all the cases
             "delta" = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)) # no random effect 

params = c("nu", "delta.new", "tau","mu", "delta")
```

```{r}
Model1 = jags( model.file="m1" , data=data , inits=init , 
               n.chains=3,parameters.to.save = params[1:3] ,
               n.iter =20000,n.thin=1,n.burnin = 2000)
```

```{r}
Model1
```

```{r}
mc_model = as.mcmc(Model1)
par(mar = c(2, 0.5, 4, 2), 
    oma = c(4, 4, 0.2, 0.2))
traceplot(Model1, ask = FALSE, 
          mfrow = c(2,1))
```


```{r}
# create file ggs to use the package ggmcmc to visualize the data
ggs_out = Model1$BUGSoutput$sims.array[,1,][,-2] %>%
          as.mcmc() %>%
          ggs()
```





```{r}
# plot the histogram of values generated by the the MCMC process
ggs_histogram(ggs_out[1:19000,], )+labs(title = "Empirical Values of delta.new from MCMC")
ggs_histogram(ggs_out[19001:38000,])+labs(title = "Empirical Values of nu from MCMC")
ggs_histogram(ggs_out[38001:57000,])+labs(title = "Empirical Values of tau from MCMC",)
```


```{r}
# save in appropriate variable 
delta.new_posterior = Model1$BUGSoutput$summary[1,1]
nu_posterior        = Model1$BUGSoutput$summary[3,1]
sigma_posterior       = 1/sqrt(Model1$BUGSoutput$summary[4,1])
```


```{r}
# having some estimates for the parameters nu and tau (mean and variance of the random effect delta respectively) is it possible to plot the original distribution declared in the model with the new parameters found with MCMC procedure
ggplot(data = data.frame(x = c(-5, 5)), aes(x)) + 
stat_function(fun = dnorm, args = list(mean = 0, sd = 1), mapping =) +
stat_function(fun = dnorm, args = list(mean = nu_posterior, sd = sigma_posterior)) +
labs(title = paste("Prior distribution of delta",expression(delta)))+
scale_fill_brewer(palette="Dark2")
```

```{r}
curve(dnorm(x, mean = nu_posterior, sd = sigma_posterior), from = -3, to = 3)
curve(dnorm(x, mean = 0, sd=1), add = TRUE)
```

```{r}
model2 = "model
    {
       for( i in 1 : Num ) {
          rc[i] ~ dbin(pc[i], nc[i])
          rt[i] ~ dbin(pt[i], nt[i])
          logit(pc[i]) <- mu[i]
          logit(pt[i]) <- mu[i] + delta[i]
          mu[i] ~ dnorm(0.0,1.0E-5)
          delta[i] ~ dt(d, tau, 3)
       }
       d ~ dnorm(0.0,1.0E-6)
       tau ~ dgamma(0.001,0.001)
       delta.new ~ dt(d, tau, 3)
       sigma <- 1 / sqrt(tau)
    }"

writeLines( model2 , con="m2" )

init2 = list(list (d = 0, 
              delta.new = 0, 
              tau=1, 
              mu = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
              delta = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)))

params2 = c("d", "delta.new", "tau","mu", "delta")

Model2 = jags( model.file="m2" , data=data , inits=init2 , 
                        n.chains=1,parameters.to.save = params2[1:3],
                        n.iter =20000,n.thin=1,n.burnin = 1000)

```

```{r}
print(Model2)
```

```{r}
ggplot(data = data.frame(x = logit_pc), aes(x)) +
geom_histogram(bins = 5,
               color = "blue3",
               fill = "cornflowerblue")+
labs(title = "Histogram of empirical log odds",subtitle = "Control Group", x = "Logit(p)", y = "Frequency")
```



```{r}
# create some data to work with
x = rnorm(1000);

# overlay histogram, empirical density and normal density
p0 = qplot(x, geom = 'blank') +   
  geom_line(aes(y = ..density.., colour = 'Empirical'), stat = 'density') +  
  stat_function(fun = dnorm, args = list(mean = 0, sd = 1), aes(colour = 'Normal')) +                       
  geom_histogram(aes(y = ..density..), alpha = 0.4) +                        
  scale_colour_manual(name = 'Density', values = c('red', 'blue')) + 
  theme(legend.position = c(0.85, 0.85))

print(p0)
```

